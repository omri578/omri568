<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>×œ×•×— ×ª×•×¦××•×ª</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5b2a">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    body{font-family:'Heebo',Arial,sans-serif;background:#000;overscroll-behavior:none;}

    .app{
      min-height:100vh;
      background:url("assets/pitch.png") center/cover no-repeat;
      position:relative;display:flex;align-items:center;justify-content:center;padding:16px;
    }
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .content{position:relative;z-index:2;width:100%;max-width:900px}
    h1{color:#fff;text-align:center;margin-bottom:16px;font-weight:900}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .team{width:30%;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;}
    .logo{width:100px;height:100px;border-radius:18px;overflow:hidden;border:3px solid #fff;}
    .logo img{width:100%;height:100%;object-fit:cover}
    .name{color:#fff;font-weight:800;text-align:center}
    .scorebox{background:rgba(0,0,0,.7);border-radius:18px;padding:14px 20px;display:flex;align-items:center;gap:16px;}
    .score{color:#fff;font-size:52px;font-weight:900;cursor:pointer;user-select:none;touch-action:manipulation;}
    .dash{color:#fff;font-size:36px;font-weight:700}
    .buttons{display:flex;justify-content:center;gap:10px;margin-top:16px;flex-wrap:wrap;}
    button{padding:10px 16px;border:none;border-radius:12px;font-weight:800;cursor:pointer;
      font-family:'Heebo',Arial,sans-serif;touch-action:manipulation;min-height:44px;}
    .btn-reset{background:#fff}
    .btn-undo{background:#ffd54a}
    .btn-var{background:#ff7676}
    .btn-half{background:#7ad1ff}
    .btn-lineup{background:#FFE000;color:#005234;border:2px solid #005234;font-size:15px;display:none;}
    .varStatus{color:#fff;text-align:center;margin-top:12px;font-weight:900;
      background:rgba(0,0,0,.6);padding:8px 12px;border-radius:12px;}

    dialog{border:none;border-radius:16px;padding:14px;max-width:500px;width:90%;}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;}
    .pick{border:2px solid #ddd;border-radius:14px;padding:8px;cursor:pointer;text-align:center;
      background:#fff;touch-action:manipulation;}
    .pick img{width:70px;height:70px;border-radius:14px;object-fit:cover;}

    /* LINEUP MODAL */
    .lineup-modal{
      display:none;position:fixed;inset:0;z-index:1000;
      background:rgba(0,0,0,.92);overflow-y:auto;
      overscroll-behavior:contain;-webkit-overflow-scrolling:touch;
    }
    .lineup-modal.open{display:block;}
    .lineup-inner{
      background:#005234;min-height:100vh;
      padding:0 14px 50px;width:100%;max-width:680px;margin:0 auto;color:#fff;
    }
    .lineup-header{
      display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;background:#005234;z-index:20;
      padding:12px 0;border-bottom:1px solid rgba(255,255,255,.15);
      margin-bottom:14px;
    }
    .lineup-title{display:flex;align-items:center;gap:10px;font-weight:900;font-size:18px;}
    .lineup-title img{width:36px;height:36px;border-radius:8px;object-fit:cover}
    .btn-close-lineup{
      background:rgba(255,255,255,.2);color:#fff;border:none;border-radius:10px;
      padding:10px 18px;cursor:pointer;font-weight:700;font-size:16px;min-height:48px;min-width:60px;
    }

    .formation-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .f-btn{
      background:rgba(255,255,255,.15);color:#fff;
      border:2px solid rgba(255,255,255,.3);border-radius:10px;
      padding:9px 14px;cursor:pointer;font-weight:700;font-size:14px;
      min-height:48px;touch-action:manipulation;
    }
    .f-btn.active{background:#FFE000;color:#005234;border-color:#FFE000;}

    /* Pitch */
    .pitch-wrap{
      position:relative;width:100%;aspect-ratio:3/4;
      background:linear-gradient(180deg,#1e8a45 0%,#166e37 50%,#1e8a45 100%);
      border-radius:14px;overflow:hidden;border:2px solid rgba(255,255,255,.4);
      touch-action:none;
    }
    .pitch-wrap::before{
      content:'';position:absolute;inset:0;
      background:repeating-linear-gradient(180deg,
        rgba(0,0,0,.07) 0,rgba(0,0,0,.07) 12.5%,transparent 12.5%,transparent 25%);
      pointer-events:none;
    }
    .pitch-lines{position:absolute;inset:0;pointer-events:none;}
    .pitch-lines svg{width:100%;height:100%;}

    /* Player token */
    .player-token{
      position:absolute;display:flex;flex-direction:column;align-items:center;gap:4px;
      transform:translate(-50%,-50%);z-index:10;
      padding:8px;cursor:grab;touch-action:none;
      user-select:none;-webkit-user-select:none;will-change:left,top;
    }
    .player-token.dragging{
      z-index:200;cursor:grabbing;opacity:.92;
      filter:drop-shadow(0 6px 16px rgba(0,0,0,.7));
      transform:translate(-50%,-50%) scale(1.15);
    }
    .player-avatar{
      width:58px;height:58px;border-radius:50%;
      background:#FFE000;border:3px solid #fff;
      overflow:hidden;display:flex;align-items:center;justify-content:center;
      font-size:20px;font-weight:900;color:#005234;
      flex-shrink:0;box-shadow:0 2px 10px rgba(0,0,0,.55);position:relative;
    }
    .player-avatar img{width:100%;height:100%;object-fit:cover;object-position:top center;border-radius:50%;}
    .player-name{
      background:rgba(0,0,0,.85);color:#fff;font-size:11px;font-weight:700;
      padding:3px 7px;border-radius:6px;
      white-space:nowrap;max-width:82px;text-align:center;
      overflow:hidden;text-overflow:ellipsis;
    }
    .player-num{
      position:absolute;bottom:-2px;right:-2px;
      background:#FFE000;color:#005234;border-radius:50%;
      width:20px;height:20px;font-size:10px;font-weight:900;
      display:flex;align-items:center;justify-content:center;
      border:1.5px solid #005234;
    }

    /* Drop overlay */
    .drop-overlay{
      display:none;position:absolute;inset:0;
      border:3px dashed rgba(255,224,0,.8);border-radius:12px;
      background:rgba(255,224,0,.08);pointer-events:none;z-index:50;
    }
    .pitch-wrap.drag-active .drop-overlay{display:block;}

    /* Bench */
    .bench-section{margin-top:16px;}
    .bench-title{font-weight:700;margin-bottom:10px;opacity:.85;font-size:14px;}
    .bench-scroll{
      display:flex;gap:10px;overflow-x:auto;padding-bottom:10px;
      -webkit-overflow-scrolling:touch;
    }
    .bench-scroll::-webkit-scrollbar{height:4px;}
    .bench-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.3);border-radius:4px;}
    .bench-player{
      display:flex;flex-direction:column;align-items:center;gap:5px;
      background:rgba(255,255,255,.12);border-radius:12px;
      padding:10px 12px;cursor:grab;touch-action:none;
      user-select:none;-webkit-user-select:none;flex-shrink:0;min-width:74px;
    }
    .bench-avatar{
      width:50px;height:50px;border-radius:50%;background:#FFE000;
      border:2px solid rgba(255,255,255,.6);overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      font-size:16px;font-weight:900;color:#005234;
      flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.4);
    }
    .bench-avatar img{width:100%;height:100%;object-fit:cover;object-position:top center;border-radius:50%;}
    .bench-name{font-size:11px;font-weight:700;text-align:center;max-width:70px;line-height:1.3;}
    .bench-pos{font-size:10px;opacity:.65;text-align:center;}

    .zoomHalf{animation:halfZoom 1.8s ease;transform-origin:center;}
    @keyframes halfZoom{0%{transform:scale(1)}40%{transform:scale(1.35)}70%{transform:scale(1.25)}100%{transform:scale(1)}}

    @media(max-width:400px){
      .player-avatar{width:48px;height:48px;font-size:17px;}
      .player-name{font-size:10px;max-width:66px;}
    }
  </style>
</head>
<body>

<div class="app">
  <div class="overlay"></div>
  <div class="content" id="mainContent">
    <h1>×œ×•×— ×ª×•×¦××•×ª</h1>
    <div class="row">
      <div class="team" onclick="openPicker('home')">
        <div class="logo"><img id="homeLogo" src="assets/team1.png"></div>
        <div class="name" id="homeName">×§×‘×•×¦×” ××³</div>
      </div>
      <div class="scorebox">
        <div class="score" id="homeScore">0</div>
        <div class="dash">-</div>
        <div class="score" id="awayScore">0</div>
      </div>
      <div class="team" onclick="openPicker('away')">
        <div class="logo"><img id="awayLogo" src="assets/team2.png"></div>
        <div class="name" id="awayName">×§×‘×•×¦×” ×‘×³</div>
      </div>
    </div>
    <div class="buttons">
      <button class="btn-reset" onclick="resetScore()">××™×¤×•×¡</button>
      <button class="btn-undo" onclick="undoGoal()">×‘×˜×œ ×’×•×œ</button>
      <button class="btn-var" onclick="runVAR()">VAR</button>
      <button class="btn-half" onclick="runHalf()">××—×¦×™×ª</button>
      <button class="btn-lineup" id="lineupBtn" onclick="openLineup()">ğŸŸ¡ ×”×¨×›×‘ ××›×‘×™</button>
    </div>
    <div class="varStatus" id="varStatus">VAR: ××™×Ÿ ×‘×“×™×§×” ×›×¨×’×¢</div>
  </div>
</div>

<audio id="goalSound" src="assets/goal.mp3"></audio>
<audio id="whistleSound" src="assets/whistle.mp3"></audio>

<dialog id="picker">
  <h3 id="pickerTitle">×‘×—×¨ ×§×‘×•×¦×”</h3>
  <div class="grid" id="grid"></div>
  <div style="text-align:right;margin-top:10px">
    <button onclick="picker.close()">×¡×’×•×¨</button>
  </div>
</dialog>

<!-- LINEUP MODAL -->
<div class="lineup-modal" id="lineupModal">
  <div class="lineup-inner">
    <div class="lineup-header">
      <div class="lineup-title">
        <img src="assets/team1.png" id="lineupLogo" alt="">
        <span>×”×¨×›×‘ ××›×‘×™ ×ª×´×</span>
      </div>
      <button class="btn-close-lineup" onclick="closeLineup()">âœ• ×¡×’×•×¨</button>
    </div>

    <div class="formation-bar" id="formationBar"></div>

    <div class="pitch-wrap" id="pitchWrap">
      <div class="drop-overlay"></div>
      <div class="pitch-lines">
        <svg viewBox="0 0 100 133" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="98" height="131" fill="none" stroke="rgba(255,255,255,.55)" stroke-width=".8"/>
          <line x1="1" y1="66" x2="99" y2="66" stroke="rgba(255,255,255,.45)" stroke-width=".6"/>
          <circle cx="50" cy="66" r="10" fill="none" stroke="rgba(255,255,255,.35)" stroke-width=".6"/>
          <circle cx="50" cy="66" r=".9" fill="rgba(255,255,255,.5)"/>
          <rect x="22" y="1" width="56" height="18" fill="none" stroke="rgba(255,255,255,.4)" stroke-width=".6"/>
          <rect x="36" y="1" width="28" height="8" fill="none" stroke="rgba(255,255,255,.35)" stroke-width=".5"/>
          <circle cx="50" cy="14" r=".9" fill="rgba(255,255,255,.4)"/>
          <rect x="22" y="114" width="56" height="18" fill="none" stroke="rgba(255,255,255,.4)" stroke-width=".6"/>
          <rect x="36" y="124" width="28" height="8" fill="none" stroke="rgba(255,255,255,.35)" stroke-width=".5"/>
          <circle cx="50" cy="120" r=".9" fill="rgba(255,255,255,.4)"/>
        </svg>
      </div>
    </div>

    <div class="bench-section">
      <div class="bench-title">ğŸª‘ ×¡×¤×¡×œ â€” ×’×¨×•×¨ ×©×—×§×Ÿ ×œ××’×¨×© ×œ×”×—×œ×¤×”</div>
      <div class="bench-scroll" id="benchRow"></div>
    </div>
  </div>
</div>

<script>
/* ===== TEAMS ===== */
const teams=[
  {name:"××›×‘×™ ×ª×œ ××‘×™×‘",logo:"assets/team1.png"},
  {name:"×”×¤×•×¢×œ ×ª×œ ××‘×™×‘",logo:"assets/team2.png"},
  {name:"××›×‘×™ ×—×™×¤×”",logo:"assets/team3.png"},
  {name:"×‘×™×ª×´×¨ ×™×¨×•×©×œ×™×",logo:"assets/team4.png"},
  {name:"×”×¤×•×¢×œ ×‘××¨ ×©×‘×¢",logo:"assets/team5.png"},
  {name:"× ×ª× ×™×”",logo:"assets/team6.png"},
  {name:"×‘× ×™ ×¨×™×™× ×”",logo:"assets/beni.png"},
  {name:"×¤×ª×— ×ª×§×•×•×”",logo:"assets/pet.png"},
  {name:"××¡ ××©×“×•×“",logo:"assets/Ashdod.png"},
  {name:"×”×¤×•×¢×œ ×¤×¨×“×¡×™×”",logo:"assets/par.jpg"},
  {name:"×¨×™××œ ××“×¨×™×“",logo:"assets/real.png"},
  {name:"×‘×¨×¦×œ×•× ×”",logo:"assets/barcelona.png"},
  {name:"×¤×¨×™×– ×¡×Ÿ ×–'×¨××Ÿ",logo:"assets/psg.png"},
  {name:"×× ×¦'×¡×˜×¨ ×¡×™×˜×™",logo:"assets/mancity.png"},
  {name:"×× ×¦'×¡×˜×¨ ×™×•× ×™×™×˜×“",logo:"assets/manutd.png"},
  {name:"××™× ×˜×¨",logo:"assets/inter.png"},
  {name:"××•× ××§×•",logo:"assets/monaco.png"},
  {name:"×™×•×‘× ×˜×•×¡",logo:"assets/juve.png"},
  {name:"×‘×™×™×¨××Ÿ ××™× ×›×Ÿ",logo:"assets/muc.png"},
  {name:"×“×•×¨×˜××•× ×“",logo:"assets/dort.png"}
];

/* ===== MACCABI PLAYERS (2025/26) =====
   Photos loaded directly from cdn.maccabi-tlv.co.il â€“ the browser fetches them at runtime.
   We try both jpg variants; onerror falls back to the player's initial.
*/
const BASE="https://cdn.maccabi-tlv.co.il/wp-content/uploads";
function p(num,name,nameEn,pos,yr,slug){
  return {id:num,num,name,nameEn,pos,
    photo:`${BASE}/${yr}/07/${slug}.jpg`};
}

const maccabiPlayers=[
  /* GK */
  p(22,"××•×¤×§ ××œ×™×§×”","Melika","GK","2024","ofek-melika"),
  p(51,"×©×œ×™×• ×¡×¢×“×™×”","Saadia","GK","2023","shliv-saadia"),
  p(90,"×¨×•×¢×™ ××©×¤×ª×™","Mishpati","GK","2023","roei-mishpati"),
  /* DEF */
  p(3,"×¨×•×™ ×¨×‘×™×‘×•","Revivo","RB","2024","roi-revivu"),
  p(4,"×”×™×™×˜×•×¨","Heitor","CB","2024","heitor"),
  p(5,"××•×—××“ ×¢×œ×™ ×§×××¨×”","Camara","CB","2024","mohamed-ali-camara"),
  p(6,"×˜×™×™×¨×™×¡ ××¡× ×˜×”","Asante","RB","2024","tyreece-asante"),
  p(13,"×¨×– ×©×œ××”","Shlomo","CB","2024","raz-shlomo"),
  p(14,"×“× ×™ ×’×¨×•×¤×¨","Gropper","LB","2022","dani-gropper"),
  p(21,"× ×•×¢× ×‘×Ÿ ×”×¨×•×©","Ben Harush","LB","2023","noam-ben-harush"),
  p(41,"××™×ª×™ ×‘×Ÿ ×—××•","Ben Hamo","CB","2024","itay-ben-hamo"),
  p(52,"×¢×™×“×Ÿ ×•×™× ×‘×¨×’","Weinberg","CB","2024","idan-weinberg"),
  /* MID */
  p(10,"×§×¨×•×•×™×Ÿ ×× ×“×¨×“×”","Andrade","AM","2024","carwin-andrade"),
  p(17,"×›×¨×™×¡×˜×™××Ÿ ×‘×œ×™×¥×³","Belic","CM","2024","kristijan-belic"),
  p(23,"×‘×Ÿ ×œ×“×¨××Ÿ","Lederman","CM","2022","ben-lederman"),
  p(28,"××™×¡×•×£ ×¡×™×¡×•×§×•","Sissokho","CM","2024","issouf-sissokho"),
  p(30,"××™×ª××¨ × ×•×™","Noy","CM","2023","itamar-noi"),
  p(36,"×¢×™×“×• ×©×—×¨","Shahar","CM","2024","ido-shahar"),
  p(42,"×“×•×¨ ×¤×¨×¥","Peretz","CM","2022","dor-peretz"),
  p(53,"×¨×•×¢×™ ××’×•×¨","Magor","CM","2024","roei-magor"),
  p(59,"×œ×•×˜× ××¡×¨×¡","Asres","CM","2024","lotem-asres"),
  /* FWD */
  p(15,"×™×•× ×¡ ××œ×“×”","Malede","LW","2024","yones-malede"),
  p(19,"××œ×¢×“ ××“××•×Ÿ","Madmon","AM","2024","elad-madmon"),
  p(29,"×”×œ×™×• ×•××¨×œ×”","Varela","LW","2024","helio-varela"),
  p(34,"×¡×™×™×“ ××‘×• ×¤×¨×—×™","Abu Farhi","ST","2024","saeed-abu-farhi"),
  p(70,"×××™×¨ ×¡×”×™×˜×™","Sahiti","ST","2024","amir-sahiti"),
  p(77,"××•×©×¨ ×“×•×™×“×”","Davida","RW","2024","osher-davida"),
  p(98,"×™×•×Ÿ × ×™×§×•×œ××¡×§×•","Nicolaescu","ST","2024","ion-nicolaescu"),
  p(11,"×©×’×™×‘ ×™×—×–×§××œ","Jehezkel","RW","2024","sagiv-yehezkel"),
];

/* ===== FORMATIONS ===== */
const formations={
  "4-3-3":[1,4,3,3],
  "4-2-3-1":[1,4,2,3,1],
  "4-4-2":[1,4,4,2],
  "3-5-2":[1,3,5,2],
  "4-3-2-1":[1,4,3,2,1],
  "5-3-2":[1,5,3,2],
};

let currentFormation="4-3-3";
let playerPositions={};
let startingEleven=[];
let benchPlayerIds=[];

/* ===== SCOREBOARD ===== */
const goalSound=document.getElementById("goalSound");
const whistleSound=document.getElementById("whistleSound");
const homeScoreEl=document.getElementById("homeScore");
const awayScoreEl=document.getElementById("awayScore");
const varStatus=document.getElementById("varStatus");
const mainContent=document.getElementById("mainContent");
let lastGoal=null;
let homeName="×§×‘×•×¦×” ××³", awayName="×§×‘×•×¦×” ×‘×³";

function playGoal(){try{goalSound.currentTime=0;goalSound.play();}catch(e){}}

homeScoreEl.addEventListener("click",()=>addGoal("home"));
awayScoreEl.addEventListener("click",()=>addGoal("away"));

function addGoal(side){
  side==="home"?homeScoreEl.textContent++:awayScoreEl.textContent++;
  lastGoal=side;varStatus.textContent="VAR: ××¤×©×¨ ×œ×‘×“×•×§ ××ª ×”×’×•×œ ×”××—×¨×•×Ÿ";
  playGoal();
}
function resetScore(){
  homeScoreEl.textContent=0;awayScoreEl.textContent=0;
  lastGoal=null;varStatus.textContent="VAR: ××™×Ÿ ×‘×“×™×§×” ×›×¨×’×¢";
}
function undoGoal(){
  if(lastGoal==="home"&&+homeScoreEl.textContent>0)homeScoreEl.textContent--;
  else if(lastGoal==="away"&&+awayScoreEl.textContent>0)awayScoreEl.textContent--;
  lastGoal=null;varStatus.textContent="VAR: ××™×Ÿ ×‘×“×™×§×” ×›×¨×’×¢";
}
function runVAR(){
  if(!lastGoal){varStatus.textContent="VAR: ××™×Ÿ ×’×•×œ ×œ×‘×“×™×§×”";return;}
  if(Math.random()<0.5){
    varStatus.textContent="VAR: âœ… ×”×’×•×œ ××•×©×¨!";
  }else{
    varStatus.textContent="VAR: âŒ ×”×’×•×œ × ×¤×¡×œ!";
    if(lastGoal==="home"&&+homeScoreEl.textContent>0)homeScoreEl.textContent--;
    if(lastGoal==="away"&&+awayScoreEl.textContent>0)awayScoreEl.textContent--;
  }
  lastGoal=null;
}
function runHalf(){
  try{whistleSound.currentTime=0;whistleSound.play();}catch(e){}
  mainContent.classList.remove("zoomHalf");
  void mainContent.offsetWidth;
  mainContent.classList.add("zoomHalf");
}

/* ===== TEAM PICKER ===== */
const pickerDlg=document.getElementById("picker");
const grid=document.getElementById("grid");
let pickSide="home";

function isMaccabi(n){return n.includes("××›×‘×™ ×ª×œ ××‘×™×‘");}
function updateLineupButton(){
  document.getElementById("lineupBtn").style.display=
    (isMaccabi(homeName)||isMaccabi(awayName))?"inline-block":"none";
}

function openPicker(side){
  pickSide=side;
  document.getElementById("pickerTitle").textContent=
    side==="home"?"×‘×—×¨ ×§×‘×•×¦×” (×‘×™×ª)":"×‘×—×¨ ×§×‘×•×¦×” (×—×•×¥)";
  grid.innerHTML="";
  teams.forEach(t=>{
    const d=document.createElement("div");
    d.className="pick";
    d.innerHTML=`<img src="${t.logo}" loading="lazy"><div>${t.name}</div>`;
    d.onclick=()=>{
      document.getElementById(pickSide+"Logo").src=t.logo;
      document.getElementById(pickSide+"Name").textContent=t.name;
      if(pickSide==="home")homeName=t.name;else awayName=t.name;
      updateLineupButton();
      pickerDlg.close();
    };
    grid.appendChild(d);
  });
  pickerDlg.showModal();
}

/* ===== LINEUP ===== */
function buildFormationButtons(){
  const bar=document.getElementById("formationBar");
  bar.innerHTML="";
  Object.keys(formations).forEach(k=>{
    const b=document.createElement("button");
    b.className="f-btn"+(k===currentFormation?" active":"");
    b.textContent=k;
    b.onclick=()=>{
      currentFormation=k;
      bar.querySelectorAll(".f-btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      buildPitch();
    };
    bar.appendChild(b);
  });
}

function getDefaultPositions(key){
  const lines=formations[key];
  const n=lines.length;
  const pos=[];
  lines.forEach((count,li)=>{
    const y=88-(li/(n-1))*76;
    for(let i=0;i<count;i++){
      pos.push({x:count===1?50:10+(i/(count-1))*80, y});
    }
  });
  return pos;
}

function assignStarting(){
  const usedIds=new Set();
  const gks=maccabiPlayers.filter(p=>p.pos==="GK");
  const defs=maccabiPlayers.filter(p=>["CB","RB","LB"].includes(p.pos));
  const mids=maccabiPlayers.filter(p=>["CM","AM","DM"].includes(p.pos));
  const fwds=maccabiPlayers.filter(p=>["ST","LW","RW"].includes(p.pos));
  const lines=formations[currentFormation];
  const picked=[];

  function take(pool,n){
    const r=[];
    for(const p of pool)if(!usedIds.has(p.id)&&r.length<n){r.push(p);usedIds.add(p.id);}
    for(const p of maccabiPlayers)if(!usedIds.has(p.id)&&r.length<n){r.push(p);usedIds.add(p.id);}
    return r;
  }

  picked.push(...take(gks,lines[0]));
  picked.push(...take(defs,lines[1]));
  lines.slice(2,-1).forEach(c=>picked.push(...take(mids,c)));
  picked.push(...take(fwds,lines[lines.length-1]));

  startingEleven=picked.map(p=>p.id);
  benchPlayerIds=maccabiPlayers.filter(p=>!usedIds.has(p.id)).map(p=>p.id);
}

function buildPitch(){
  assignStarting();
  const def=getDefaultPositions(currentFormation);
  playerPositions={};
  startingEleven.forEach((_,i)=>playerPositions[i]=def[i]);
  renderPitch();
  renderBench();
}

function getPlayer(id){return maccabiPlayers.find(p=>p.id===id);}

function makeAvatar(player,cls){
  const div=document.createElement("div");
  div.className=cls;
  if(player.photo){
    const img=document.createElement("img");
    img.loading="lazy";img.alt=player.nameEn;
    img.src=player.photo;
    img.onerror=function(){
      this.remove();
      div.textContent=player.nameEn.charAt(0).toUpperCase();
    };
    div.appendChild(img);
  }else{
    div.textContent=player.nameEn.charAt(0).toUpperCase();
  }
  return div;
}

function renderPitch(){
  const wrap=document.getElementById("pitchWrap");
  wrap.querySelectorAll(".player-token").forEach(el=>el.remove());
  startingEleven.forEach((pid,si)=>{
    const p=getPlayer(pid);if(!p)return;
    const token=document.createElement("div");
    token.className="player-token";token.dataset.slot=si;

    const av=makeAvatar(p,"player-avatar");
    const nb=document.createElement("div");
    nb.className="player-num";nb.textContent=p.num;
    av.appendChild(nb);

    const nm=document.createElement("div");
    nm.className="player-name";
    const parts=p.name.split(" ");
    nm.textContent=parts.length>1?parts[parts.length-1]:p.name;

    token.appendChild(av);token.appendChild(nm);
    const pos=playerPositions[si];
    token.style.left=pos.x+"%";token.style.top=pos.y+"%";
    wrap.appendChild(token);
    attachPitchDrag(token,si);
  });
}

function renderBench(){
  const row=document.getElementById("benchRow");
  row.innerHTML="";
  benchPlayerIds.forEach(pid=>{
    const p=getPlayer(pid);if(!p)return;
    const el=document.createElement("div");
    el.className="bench-player";el.dataset.pid=pid;
    const av=makeAvatar(p,"bench-avatar");
    const nm=document.createElement("div");nm.className="bench-name";nm.textContent=p.name;
    const ps=document.createElement("div");ps.className="bench-pos";ps.textContent="#"+p.num+" "+p.pos;
    el.appendChild(av);el.appendChild(nm);el.appendChild(ps);
    row.appendChild(el);
    attachBenchDrag(el,pid);
  });
}

/* ===== DRAG HELPERS ===== */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function getXY(e){
  const s=e.changedTouches?e.changedTouches[0]:e.touches?e.touches[0]:e;
  return{x:s.clientX,y:s.clientY};
}

function attachPitchDrag(token,si){
  const wrap=document.getElementById("pitchWrap");
  function onStart(e){
    e.preventDefault();e.stopPropagation();
    token.classList.add("dragging");
    function onMove(ev){
      ev.preventDefault();
      const{x,y}=getXY(ev);
      const r=wrap.getBoundingClientRect();
      const xp=clamp((x-r.left)/r.width*100,4,96);
      const yp=clamp((y-r.top)/r.height*100,4,96);
      token.style.left=xp+"%";token.style.top=yp+"%";
      playerPositions[si]={x:xp,y:yp};
    }
    function onEnd(){
      token.classList.remove("dragging");
      off();
    }
    function off(){
      document.removeEventListener("mousemove",onMove);
      document.removeEventListener("mouseup",onEnd);
      document.removeEventListener("touchmove",onMove);
      document.removeEventListener("touchend",onEnd);
    }
    document.addEventListener("mousemove",onMove,{passive:false});
    document.addEventListener("mouseup",onEnd);
    document.addEventListener("touchmove",onMove,{passive:false});
    document.addEventListener("touchend",onEnd);
  }
  token.addEventListener("mousedown",onStart);
  token.addEventListener("touchstart",onStart,{passive:false});
}

function attachBenchDrag(el,pid){
  const wrap=document.getElementById("pitchWrap");
  function onStart(e){
    e.preventDefault();
    const{x:sx,y:sy}=getXY(e);
    const ghost=el.cloneNode(true);
    Object.assign(ghost.style,{
      position:"fixed",zIndex:"9999",pointerEvents:"none",
      opacity:"0.92",transform:"scale(1.1) rotate(-2deg)",
      left:(sx-37)+"px",top:(sy-70)+"px",
      background:"rgba(0,60,30,.95)",borderRadius:"12px",padding:"10px",
      boxShadow:"0 8px 24px rgba(0,0,0,.6)"
    });
    document.body.appendChild(ghost);
    wrap.classList.add("drag-active");

    function onMove(ev){
      ev.preventDefault();
      const{x,y}=getXY(ev);
      ghost.style.left=(x-37)+"px";ghost.style.top=(y-70)+"px";
    }
    function onEnd(ev){
      ghost.remove();wrap.classList.remove("drag-active");off();
      const fc=ev.changedTouches?ev.changedTouches[0]:ev;
      const r=wrap.getBoundingClientRect();
      if(fc.clientX<r.left||fc.clientX>r.right||fc.clientY<r.top||fc.clientY>r.bottom)return;
      const xp=clamp((fc.clientX-r.left)/r.width*100,4,96);
      const yp=clamp((fc.clientY-r.top)/r.height*100,4,96);
      // nearest slot
      let nearest=0,nd=9999;
      startingEleven.forEach((_,i)=>{
        const pp=playerPositions[i];if(!pp)return;
        const d=Math.hypot(pp.x-xp,pp.y-yp);
        if(d<nd){nd=d;nearest=i;}
      });
      const swappedId=startingEleven[nearest];
      startingEleven[nearest]=pid;
      benchPlayerIds=benchPlayerIds.filter(x=>x!==pid);
      if(!benchPlayerIds.includes(swappedId))benchPlayerIds.unshift(swappedId);
      playerPositions[nearest]={x:xp,y:yp};
      renderPitch();renderBench();
    }
    function off(){
      document.removeEventListener("mousemove",onMove);
      document.removeEventListener("mouseup",onEnd);
      document.removeEventListener("touchmove",onMove);
      document.removeEventListener("touchend",onEnd);
    }
    document.addEventListener("mousemove",onMove,{passive:false});
    document.addEventListener("mouseup",onEnd);
    document.addEventListener("touchmove",onMove,{passive:false});
    document.addEventListener("touchend",onEnd,{passive:false});
  }
  el.addEventListener("mousedown",onStart);
  el.addEventListener("touchstart",onStart,{passive:false});
}

function openLineup(){
  document.getElementById("lineupModal").classList.add("open");
  document.body.style.overflow="hidden";
  buildFormationButtons();
  buildPitch();
}
function closeLineup(){
  document.getElementById("lineupModal").classList.remove("open");
  document.body.style.overflow="";
}

if("serviceWorker"in navigator)navigator.serviceWorker.register("sw.js");
</script>
</body>
</html>
